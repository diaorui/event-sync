name: Deploy to Google Apps Script

on:
  push:
    branches:
      - main
    paths:
      - 'apps-script/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow pushing commits back to repo

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Setup clasp
        run: |
          # Write secrets to files (using printf to preserve exact formatting)
          printf '%s\n' "$CLASPRC_JSON" > ~/.clasprc.json
          printf '%s\n' "$CLASP_JSON" > .clasp.json

          # Validate JSON files
          echo "Validating configuration files..."
          if ! cat ~/.clasprc.json | jq empty 2>/dev/null; then
            echo "Error: Invalid JSON in CLASPRC_JSON secret"
            exit 1
          fi

          if ! cat .clasp.json | jq empty 2>/dev/null; then
            echo "Error: Invalid JSON in CLASP_JSON secret"
            exit 1
          fi

          # Auto-fix rootDir if it's wrong or missing
          SCRIPT_ID=$(cat .clasp.json | jq -r '.scriptId')
          echo "Script ID: $SCRIPT_ID"

          cat > .clasp.json <<EOF
          {
            "scriptId": "$SCRIPT_ID",
            "rootDir": "./apps-script"
          }
          EOF

          echo "âœ“ clasp configuration files created successfully"
        env:
          CLASPRC_JSON: ${{ secrets.CLASPRC_JSON }}
          CLASP_JSON: ${{ secrets.CLASP_JSON }}

      - name: Push to Google Apps Script
        run: npx clasp push --force

      - name: Deploy and get URL
        id: deploy
        run: |
          # Create a new versioned deployment for backup/rollback
          echo "Creating versioned deployment..."
          DEPLOY_OUTPUT=$(npx clasp deploy --description "Auto-deploy from GitHub Actions - ${{ github.sha }}" 2>&1)
          echo "$DEPLOY_OUTPUT"

          # Extract deployment ID from the deploy output (the line: "Deployed AKfycb... @N")
          LATEST_DEPLOYMENT=$(echo "$DEPLOY_OUTPUT" | grep "^Deployed" | grep -oP 'AKfycb[a-zA-Z0-9_-]+')

          if [ -z "$LATEST_DEPLOYMENT" ]; then
            echo "Error: Could not extract deployment ID from deploy output"
            exit 1
          fi

          # Construct GAS URL using the latest deployment
          GAS_URL="https://script.google.com/macros/s/${LATEST_DEPLOYMENT}/exec"
          echo "deployment_id=$LATEST_DEPLOYMENT" >> $GITHUB_OUTPUT
          echo "gas_url=$GAS_URL" >> $GITHUB_OUTPUT
          echo "âœ“ Deployed to: $GAS_URL"

      - name: Cleanup old deployments
        run: |
          echo "Checking for old deployments to clean up..."

          # Get all versioned deployments (exclude @HEAD)
          DEPLOYMENT_LIST=$(npx clasp deployments 2>&1 | grep '@[0-9]')

          if [ -z "$DEPLOYMENT_LIST" ]; then
            echo "No versioned deployments found"
            exit 0
          fi

          # Extract version numbers and sort
          VERSIONS=$(echo "$DEPLOYMENT_LIST" | grep -oP '@\K[0-9]+' | sort -n)
          DEPLOY_COUNT=$(echo "$VERSIONS" | wc -l)
          echo "Found $DEPLOY_COUNT versioned deployment(s)"

          # Keep last 5 deployments, delete older ones
          KEEP_COUNT=5

          if [ "$DEPLOY_COUNT" -gt "$KEEP_COUNT" ]; then
            DELETE_COUNT=$((DEPLOY_COUNT - KEEP_COUNT))
            echo "Deleting $DELETE_COUNT old deployment(s), keeping last $KEEP_COUNT"

            # Get versions to delete (oldest ones)
            VERSIONS_TO_DELETE=$(echo "$VERSIONS" | head -n "$DELETE_COUNT")

            # Delete each old deployment by finding its ID
            for VERSION in $VERSIONS_TO_DELETE; do
              DEPLOY_ID=$(echo "$DEPLOYMENT_LIST" | grep "@$VERSION" | grep -oP 'AKfycb[a-zA-Z0-9_-]+' | head -1)
              if [ -n "$DEPLOY_ID" ]; then
                echo "Deleting deployment @$VERSION ($DEPLOY_ID)"
                npx clasp undeploy "$DEPLOY_ID" || echo "Failed to delete $DEPLOY_ID"
              fi
            done

            echo "âœ“ Cleanup complete"
          else
            echo "Only $DEPLOY_COUNT deployment(s), no cleanup needed (keeping last $KEEP_COUNT)"
          fi

      - name: Update GAS_URL in HTML
        if: success()
        run: |
          node scripts/update-gas-url.js "${{ steps.deploy.outputs.gas_url }}"

      - name: Commit updated HTML
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/index.html
          git diff --staged --quiet || git commit -m "ðŸ¤– Auto-update GAS_URL after deployment [skip ci]"
          git push
