<!DOCTYPE html>
<html>
<head>
  <title>Event Sync - Luma to Google Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/eventsync-logo.png">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f4f4; padding: 20px; text-align: center; }
    
    .card { 
      background: white; 
      max-width: 500px; 
      margin: 0 auto; 
      padding: 30px; 
      border-radius: 12px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
    }

    h2 { color: #333; }
    p.subtext { color: #666; margin-bottom: 15px; font-size: 14px; }

    .logo-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    .logo-header img {
      width: 48px;
      height: 48px;
      object-fit: contain;
    }
    .logo-header h2 {
      margin: 0;
    }

    .info-note {
      background: #e3f2fd;
      border-left: 3px solid #2196f3;
      padding: 10px 12px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #555;
      line-height: 1.5;
      border-radius: 4px;
    }

    /* Map Styling */
    #map { 
      height: 350px; 
      width: 100%; 
      border-radius: 8px; 
      margin-bottom: 10px; 
      border: 2px solid #eee;
      z-index: 1; 
    }

    /* Form Elements */
    label { display: block; text-align: left; font-weight: bold; margin-bottom: 8px; color: #333; font-size: 14px;}
    select { 
      width: 100%; padding: 12px; border-radius: 6px; 
      border: 1px solid #ccc; font-size: 16px; margin-bottom: 20px; background: #fff;
    }
    
    button { 
      background: #000; color: #fff; font-size: 16px; font-weight: bold;
      padding: 15px; width: 100%; border: none; border-radius: 6px; cursor: pointer; 
      transition: background 0.2s; margin-top: 10px;
    }
    button:hover { background: #333; }

    #status { margin-top: 20px; font-size: 14px; line-height: 1.5; }

    .coord-display { font-size: 13px; color: #555; margin-bottom: 15px; text-align: right; font-family: monospace;}

    .footer {
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid #eee;
      text-align: center;
      font-size: 13px;
      color: #777;
    }
    .footer a {
      color: #2196f3;
      text-decoration: none;
      font-weight: 500;
    }
    .footer a:hover {
      text-decoration: underline;
    }

    .privacy-note {
      font-size: 12px;
      color: #888;
      margin-top: 15px;
      margin-bottom: -5px;
      text-align: center;
      line-height: 1.4;
    }

    .map-hint {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
      margin-bottom: 15px;
      text-align: center;
      font-style: italic;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.show {
      display: flex;
    }
    .modal {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 90%;
      text-align: center;
      animation: modalSlideIn 0.3s ease;
    }
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .modal h3 {
      margin: 0 0 15px 0;
      font-size: 20px;
      color: #333;
    }
    .modal p {
      margin: 0 0 20px 0;
      color: #666;
      line-height: 1.5;
    }
    .modal-button {
      background: #2196f3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .modal-button:hover {
      background: #1976d2;
    }
    .modal-button.secondary {
      background: #666;
      margin-left: 10px;
    }
    .modal-button.secondary:hover {
      background: #555;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2196f3;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<div class="card">
  <div class="logo-header">
    <img src="/eventsync-logo.png" alt="Event Sync Logo">
    <h2>Event Sync</h2>
  </div>
  <p class="subtext">Automatically sync local events from Luma to your Google Calendar</p>

  <div class="info-note">
    ‚ÑπÔ∏è <strong>What is Luma?</strong> <a href="https://lu.ma" target="_blank" style="color: #2196f3;">lu.ma</a> is a popular event discovery platform. This tool finds events in your area and keeps your calendar up to date.
  </div>

  <label for="slug">1. Choose Category</label>
  <select id="slug">
    <option value="tech">Tech</option>
    <option value="ai" selected>AI</option>
    <option value="crypto">Crypto</option>
    <option value="arts">Arts & Culture</option>
    <option value="food">Food & Drink</option>
    <option value="fitness">Fitness</option>
    <option value="wellness">Wellness</option>
    <option value="climate">Climate</option>
  </select>

  <label>2. Select Area (Pan & Zoom Map)</label>
  <div class="map-hint" style="margin-top: 8px; margin-bottom: 10px;">‚ÑπÔ∏è Events in this area will be synced</div>
  <div id="map"></div>

  <div class="privacy-note">
    üîí We only access calendars created by this app. Your existing calendars remain private.<br>
    By authorizing, you agree to our <a href="/privacy.html" style="color: #2196f3;">Privacy Policy</a> and <a href="/terms.html" style="color: #2196f3;">Terms of Service</a>.
  </div>

  <button onclick="handleSync();">üîê Authorize & Sync</button>

  <div id="status"></div>

  <div class="footer">
    Open Source ‚Ä¢ <a href="https://github.com/diaorui/event-sync" target="_blank">GitHub</a>
  </div>
</div>

<script>
  // CONFIGURATION
  const CLIENT_ID = '465296465052-863gptjafq0b1o2ou4ovq8oggvmkgjmp.apps.googleusercontent.com'; // Paste from Step 1
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbzYrPa53aPDabT0s_WIwC1FWtdhPVVO7jlbHgUFBDho-cXYNeUFYZLLJZLvTwaGnBPbHQ/exec';     // @HEAD deployment (auto-updates)
  const REDIRECT_URI = 'postmessage';  // Special value for popup OAuth flow - works on any domain

  // --- MAP SETUP ---
  var map = L.map('map').setView([37.7749, -122.4194], 10); // Default SF

  // Add Free Tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap',
    maxZoom: 18
  }).addTo(map);

  // Add Locate Control (handles geolocation)
  L.control.locate({
    position: 'topright',
    flyTo: true,
    keepCurrentZoomLevel: true,  // User controls zoom level
    showPopup: false,             // Keep it clean, no popup
    strings: {
      title: "Show my location"
    },
    locateOptions: {
      enableHighAccuracy: false,  // Faster on mobile
      timeout: 10000,             // 10 second timeout
      maximumAge: 0               // Force fresh location
    }
  }).addTo(map);


  // --- AUTH & SYNC ---
  var client;
  window.onload = function() {
    // Check if Google OAuth library loaded
    if (typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) {
      console.error('Google OAuth library failed to load');
      return;
    }

    try {
      client = google.accounts.oauth2.initCodeClient({
        client_id: CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/calendar.app.created openid email',
        ux_mode: 'popup',
        callback: (response) => {
          if (response.code) {
            sendToBackend(response.code);
          } else if (response.error) {
            showErrorModal('Authorization failed: ' + (response.error_description || response.error));
            enableInputs();
          }
        },
        error_callback: (error) => {
          showErrorModal('Authorization error: ' + (error.message || 'Unknown error'));
          enableInputs();
        }
      });
    } catch(e) {
      console.error('Failed to initialize OAuth client:', e);
    }
  };

  // Modal helper functions
  function showModal(content) {
    document.getElementById('modal-content').innerHTML = content;
    document.getElementById('modal').classList.add('show');
  }

  function hideModal() {
    document.getElementById('modal').classList.remove('show');
  }

  function showLoadingModal() {
    showModal('<div class="spinner"></div><h3>Syncing Events</h3><p>Please wait...</p>');
  }

  function showSuccessModal(calendarName, action) {
    var calendarLink = '<a href="https://calendar.google.com/calendar" target="_blank" style="color: #2196f3; font-weight: bold; text-decoration: underline;">' + calendarName + '</a>';
    var message, subtitle;

    if (action === 'created') {
      message = 'Created calendar: ' + calendarLink;
      subtitle = 'Events are syncing now!';
    } else {
      message = 'Updated location for: ' + calendarLink;
      subtitle = 'Events will refresh on next sync (runs regularly)';
    }

    showModal(
      '<h3>‚úÖ Success!</h3>' +
      '<p>' + message + '</p>' +
      '<p style="font-size: 13px; color: #888; margin-top: -10px;">' + subtitle + '</p>' +
      '<button class="modal-button" onclick="hideModal()">Done</button>'
    );
  }

  function showErrorModal(errorMsg) {
    showModal(
      '<h3>‚ùå Error</h3>' +
      '<p>' + errorMsg + '</p>' +
      '<button class="modal-button" onclick="hideModal()">Close</button>'
    );
  }

  function disableInputs() {
    document.getElementById('slug').disabled = true;
    document.querySelector('button[onclick="handleSync();"]').disabled = true;
    map.dragging.disable();
    map.touchZoom.disable();
    map.doubleClickZoom.disable();
    map.scrollWheelZoom.disable();
  }

  function enableInputs() {
    document.getElementById('slug').disabled = false;
    document.querySelector('button[onclick="handleSync();"]').disabled = false;
    map.dragging.enable();
    map.touchZoom.enable();
    map.doubleClickZoom.enable();
    map.scrollWheelZoom.enable();
  }

  // Main sync handler - always requires authorization
  function handleSync() {
    // Check if OAuth client is ready
    if (!client) {
      showErrorModal('Authentication system is still loading. Please wait a moment and try again.');
      return;
    }

    // Always trigger OAuth for fresh authorization
    try {
      client.requestCode();
    } catch(e) {
      showErrorModal('Failed to start authentication: ' + e.message);
    }
  }

  function sendToBackend(authCode) {
    // Show loading modal and disable inputs
    showLoadingModal();
    disableInputs();

    var bounds = map.getBounds();

    const config = {
      slug: document.getElementById('slug').value,
      north: bounds.getNorth(),
      south: bounds.getSouth(),
      east: bounds.getEast(),
      west: bounds.getWest()
    };

    var payload = {
      auth_code: authCode,
      redirect_uri: REDIRECT_URI,
      config: config
    };

    fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
      enableInputs();

      if(data.status === 'success') {
        showSuccessModal(data.calendarName, data.action);
      } else {
        showErrorModal(data.msg);
      }
    })
    .catch(err => {
      enableInputs();
      showErrorModal("Network Error: " + err.message);
    });
  }
</script>

<!-- Modal -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <div id="modal-content"></div>
  </div>
</div>

</body>
</html>