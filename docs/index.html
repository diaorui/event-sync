<!DOCTYPE html>
<html>
<head>
  <title>Luma -> Google Calendar Sync</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f4f4; padding: 20px; text-align: center; }
    
    .card { 
      background: white; 
      max-width: 500px; 
      margin: 0 auto; 
      padding: 30px; 
      border-radius: 12px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
    }

    h2 { margin-top: 0; color: #333; }
    p { color: #666; margin-bottom: 20px; }

    /* Map Styling */
    #map { 
      height: 300px; 
      width: 100%; 
      border-radius: 8px; 
      margin-bottom: 15px; 
      border: 2px solid #eee;
      z-index: 1; /* Keep below dropdowns */
    }

    /* Form Elements */
    label { display: block; text-align: left; font-weight: bold; margin-bottom: 5px; color: #333; }
    select { 
      width: 100%; padding: 12px; border-radius: 6px; 
      border: 1px solid #ccc; font-size: 16px; margin-bottom: 20px; background: #fff;
    }
    
    button { 
      background: #000; color: #fff; font-size: 16px; font-weight: bold;
      padding: 15px; width: 100%; border: none; border-radius: 6px; cursor: pointer; 
      transition: background 0.2s;
    }
    button:hover { background: #333; }

    #status { margin-top: 20px; font-size: 14px; line-height: 1.5; }
    
    .coord-display { font-size: 12px; color: #999; margin-bottom: 15px; text-align: right; }
  </style>
</head>
<body>

<div class="card">
  <h2>üìÖ Luma Local Sync</h2>
  <p>Sync local events directly to your Google Calendar.</p>
  
  <label for="slug">1. Choose Category</label>
  <select id="slug">
    <option value="tech">Tech</option>
    <option value="ai" selected>AI</option>
    <option value="crypto">Crypto</option>
    <option value="arts">Arts & Culture</option>
    <option value="food">Food & Drink</option>
    <option value="fitness">Fitness</option>
    <option value="wellness">Wellness</option>
    <option value="climate">Climate</option>
  </select>

  <label>2. Select Area (Pan & Zoom)</label>
  <div id="map"></div>
  <div class="coord-display" id="coord-text">Selected Area: Silicon Valley</div>

  <button onclick="client.requestCode();">üîÑ Sync This Area</button>
  
  <div id="status"></div>
</div>

<script>
  // CONFIGURATION
  const CLIENT_ID = '465296465052-863gptjafq0b1o2ou4ovq8oggvmkgjmp.apps.googleusercontent.com'; // Paste from Step 1
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbztbxztevlcwkw5LOsKNklPUb5ASD45mxKMl1WVqx0p-ZYaNTMqFaXuw9HAbwo0-EZN7A/exec';     // Paste from Step 3 Deployment
  const REDIRECT_URI = 'https://diaorui.github.io'; // e.g. https://user.github.io

  // --- MAP SETUP ---
  // Default: San Francisco / Bay Area
  var map = L.map('map').setView([37.7749, -122.4194], 10);

  // Add Free OpenStreetMap Tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
    maxZoom: 18
  }).addTo(map);

  // Update text when user moves map
  map.on('moveend', function() {
    var b = map.getBounds();
    var center = map.getCenter();
    document.getElementById('coord-text').innerText = 
      `Selected: ${center.lat.toFixed(2)}, ${center.lng.toFixed(2)} (Width: ${(b.getEast() - b.getWest()).toFixed(2)}¬∞)`;
  });

  // --- AUTH & SYNC LOGIC ---
  var client;
  window.onload = function() {
    client = google.accounts.oauth2.initCodeClient({
      client_id: CLIENT_ID,
      scope: 'https://www.googleapis.com/auth/calendar.app.created openid email',
      ux_mode: 'popup',
      callback: (response) => {
        if (response.code) sendToBackend(response.code);
      }
    });
  };

  function sendToBackend(code) {
    var statusDiv = document.getElementById('status');
    statusDiv.innerHTML = "‚è≥ <b>Connecting...</b> <br><small>Verifying account & syncing events...</small>";
    statusDiv.style.color = "blue";
    
    // CAPTURE MAP BOUNDS DYNAMICALLY
    var bounds = map.getBounds();
    
    const config = {
      slug: document.getElementById('slug').value,
      // Leaflet gives us the exact boundaries of the visible screen
      north: bounds.getNorth(),
      south: bounds.getSouth(),
      east: bounds.getEast(),
      west: bounds.getWest()
    };

    fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({
        auth_code: code,
        redirect_uri: REDIRECT_URI,
        config: config
      })
    })
    .then(res => res.json())
    .then(data => {
      if(data.status === 'success') {
        var msg = "";
        if (data.action === 'created') {
          msg = `‚úÖ <b>Success!</b><br>Created calendar: <b>"${data.calendarName}"</b>`;
        } else {
          msg = `üîÑ <b>Updated!</b><br>Refreshed settings for: <b>"${data.calendarName}"</b>`;
        }
        statusDiv.innerHTML = msg;
        statusDiv.style.color = "green";
      } else {
        statusDiv.innerHTML = "‚ùå Error: " + data.msg;
        statusDiv.style.color = "red";
      }
    })
    .catch(err => {
      statusDiv.innerHTML = "‚ùå Network Error: " + err.message;
      statusDiv.style.color = "red";
    });
  }
</script>

</body>
</html>