<!DOCTYPE html>
<html>
<head>
  <title>EventSync</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: sans-serif; padding: 40px; text-align: center; }
    .card { max-width: 400px; margin: 0 auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
    input { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
    button { background: #000; color: #fff; padding: 10px 20px; border: none; cursor: pointer; border-radius: 4px; width: 100%; }
    #status { margin-top: 20px; color: green; }
  </style>
</head>
<body>

<div class="card">
  <h2>Luma -> Google Calendar Sync</h2>
  <p>Select your area and sync events automatically.</p>
  
  <div style="text-align: left;">
    <label>Slug (e.g., ai, tech):</label>
    <input type="text" id="slug" value="ai">
    
    <label>North Lat:</label><input type="text" id="north" value="37.8">
    <label>South Lat:</label><input type="text" id="south" value="37.3">
    <label>East Lon:</label><input type="text" id="east" value="-121.9">
    <label>West Lon:</label><input type="text" id="west" value="-122.5">
  </div>
  <br>

  <button onclick="client.requestCode();">üìÖ Connect & Sync</button>
  <div id="status"></div>
</div>

<script>
  // CONFIGURATION
  const CLIENT_ID = '465296465052-863gptjafq0b1o2ou4ovq8oggvmkgjmp.apps.googleusercontent.com'; // Paste from Step 1
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxhN1jlXY1SKvTVN9C330WHJd-z0Zq2-0qlalmK7J7ymY_jmIod94DGX434pMTjHdRAoA/exec';     // Paste from Step 3 Deployment
  const REDIRECT_URI = 'https://diaorui.github.io'; // e.g. https://user.github.io

  var client;
  
  window.onload = function() {
    client = google.accounts.oauth2.initCodeClient({
      client_id: CLIENT_ID,
      scope: 'https://www.googleapis.com/auth/calendar.app.created openid email',
      ux_mode: 'popup',
      callback: (response) => {
        if (response.code) {
          sendToBackend(response.code);
        }
      }
    });
  };

  function sendToBackend(code) {
    var statusDiv = document.getElementById('status');
    statusDiv.innerHTML = "‚è≥ <b>Connecting...</b> <br><small>We are verifying your account and checking for existing setups.</small>";
    statusDiv.style.color = "blue";
    
    const config = {
      north: document.getElementById('north').value,
      south: document.getElementById('south').value,
      east: document.getElementById('east').value,
      west: document.getElementById('west').value,
      slug: document.getElementById('slug').value
    };

    fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({
        auth_code: code,
        redirect_uri: REDIRECT_URI,
        config: config
      })
    })
    .then(res => res.json())
    .then(data => {
      if(data.status === 'success') {
        // SUCCESS MESSAGING
        var msg = "";
        
        if (data.action === 'created') {
          msg = `
            <h3>‚úÖ You are all set!</h3>
            <p>We created a new calendar called <b>"${data.calendarName}"</b> in your Google Calendar.</p>
            <p>We just ran the first sync. Go check your calendar!</p>
          `;
        } else if (data.action === 'updated') {
          msg = `
            <h3>üîÑ Settings Updated!</h3>
            <p>Welcome back, <b>${data.email}</b>.</p>
            <p>We found your existing setup and updated it to these new coordinates.</p>
            <p>Your calendar <b>"${data.calendarName}"</b> has been refreshed.</p>
          `;
        }
        
        statusDiv.innerHTML = msg;
        statusDiv.style.color = "green";
        
      } else {
        // ERROR MESSAGING
        statusDiv.innerHTML = "‚ùå <b>Error:</b> " + data.msg;
        statusDiv.style.color = "red";
      }
    })
    .catch(err => {
      statusDiv.innerHTML = "‚ùå <b>Network Error:</b> " + err.message;
      statusDiv.style.color = "red";
    });
  }
</script>

</body>
</html>