<!DOCTYPE html>
<html>
<head>
  <title>Luma -> Google Calendar Sync</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f4f4; padding: 20px; text-align: center; }
    
    .card { 
      background: white; 
      max-width: 500px; 
      margin: 0 auto; 
      padding: 30px; 
      border-radius: 12px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
    }

    h2 { margin-top: 0; color: #333; margin-bottom: 5px;}
    p.subtext { color: #666; margin-bottom: 25px; font-size: 14px; }

    /* Map Styling */
    #map { 
      height: 350px; 
      width: 100%; 
      border-radius: 8px; 
      margin-bottom: 10px; 
      border: 2px solid #eee;
      z-index: 1; 
    }

    /* Form Elements */
    label { display: block; text-align: left; font-weight: bold; margin-bottom: 8px; color: #333; font-size: 14px;}
    select { 
      width: 100%; padding: 12px; border-radius: 6px; 
      border: 1px solid #ccc; font-size: 16px; margin-bottom: 20px; background: #fff;
    }
    
    button { 
      background: #000; color: #fff; font-size: 16px; font-weight: bold;
      padding: 15px; width: 100%; border: none; border-radius: 6px; cursor: pointer; 
      transition: background 0.2s; margin-top: 10px;
    }
    button:hover { background: #333; }

    #status { margin-top: 20px; font-size: 14px; line-height: 1.5; }
    
    .coord-display { font-size: 13px; color: #555; margin-bottom: 15px; text-align: right; font-family: monospace;}
  </style>
</head>
<body>

<div class="card">
  <h2>üìÖ Luma Local Sync</h2>
  <p>Sync local events directly to your Google Calendar.</p>
  
  <label for="slug">1. Choose Category</label>
  <select id="slug">
    <option value="tech">Tech</option>
    <option value="ai" selected>AI</option>
    <option value="crypto">Crypto</option>
    <option value="arts">Arts & Culture</option>
    <option value="food">Food & Drink</option>
    <option value="fitness">Fitness</option>
    <option value="wellness">Wellness</option>
    <option value="climate">Climate</option>
  </select>

  <label>2. Select Area</label>
  <div id="map"></div>
  <div class="coord-display" id="coord-text">Center: 37.77, -122.41</div>

  <button onclick="client.requestCode();">üîÑ Sync This Area</button>
  
  <div id="status"></div>
</div>

<script>
  // CONFIGURATION
  const CLIENT_ID = '465296465052-863gptjafq0b1o2ou4ovq8oggvmkgjmp.apps.googleusercontent.com'; // Paste from Step 1
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbzUr2rOk2OlouhXo3wvFERgSUVSAknVROq0n61eCRb0ufM4AW3ZRPc9vbsuG0OfpFqEOw/exec';     // Paste from Step 3 Deployment
  const REDIRECT_URI = 'https://diaorui.github.io'; // e.g. https://user.github.io

  // --- MAP SETUP ---
  var map = L.map('map').setView([37.7749, -122.4194], 10); // Default SF

  // Add Free Tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap',
    maxZoom: 18
  }).addTo(map);

  // 2. AUTO-LOCATE USER (Browser Geolocation)
  map.locate({setView: true, maxZoom: 12});

  function onLocationFound(e) {
    // Optional: Add a marker showing "You are here"
    // L.marker(e.latlng).addTo(map).bindPopup("You are here").openPopup();
  }
  
  function onLocationError(e) {
    console.log("Could not auto-locate: " + e.message);
    // Silent fail: just stays on default view (SF)
  }

  map.on('locationfound', onLocationFound);
  map.on('locationerror', onLocationError);

  // 3. UPDATE COORDINATES DISPLAY
  function updateCoords() {
    var center = map.getCenter();
    document.getElementById('coord-text').innerText = 
      `Selected Center: ${center.lat.toFixed(3)}, ${center.lng.toFixed(3)}`;
  }
  
  map.on('moveend', updateCoords);

  // --- AUTH & SYNC ---
  var client;
  window.onload = function() {
    client = google.accounts.oauth2.initCodeClient({
      client_id: CLIENT_ID,
      scope: 'https://www.googleapis.com/auth/calendar.app.created openid email',
      ux_mode: 'popup',
      callback: (response) => {
        if (response.code) sendToBackend(response.code);
      }
    });
  };

  function sendToBackend(code) {
    var statusDiv = document.getElementById('status');
    statusDiv.innerHTML = "‚è≥ <b>Connecting...</b>";
    statusDiv.style.color = "blue";
    
    var bounds = map.getBounds();
    
    const config = {
      slug: document.getElementById('slug').value,
      north: bounds.getNorth(),
      south: bounds.getSouth(),
      east: bounds.getEast(),
      west: bounds.getWest()
    };

    fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({
        auth_code: code,
        redirect_uri: REDIRECT_URI,
        config: config
      })
    })
    .then(res => res.json())
    .then(data => {
      if(data.status === 'success') {
        var msg = "";
        if (data.action === 'created') {
          msg = `‚úÖ <b>Success!</b><br>Created calendar: <b>"${data.calendarName}"</b>`;
        } else {
          msg = `üîÑ <b>Updated!</b><br>Refreshed location for: <b>"${data.calendarName}"</b>`;
        }
        statusDiv.innerHTML = msg;
        statusDiv.style.color = "green";
      } else {
        statusDiv.innerHTML = "‚ùå Error: " + data.msg;
        statusDiv.style.color = "red";
      }
    })
    .catch(err => {
      statusDiv.innerHTML = "‚ùå Network Error: " + err.message;
      statusDiv.style.color = "red";
    });
  }
</script>

</body>
</html>