<!DOCTYPE html>
<html>
<head>
  <title>Event Sync - Luma to Google Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f4f4; padding: 20px; text-align: center; }
    
    .card { 
      background: white; 
      max-width: 500px; 
      margin: 0 auto; 
      padding: 30px; 
      border-radius: 12px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
    }

    h2 { margin-top: 0; color: #333; margin-bottom: 5px;}
    p.subtext { color: #666; margin-bottom: 25px; font-size: 14px; }

    /* Map Styling */
    #map { 
      height: 350px; 
      width: 100%; 
      border-radius: 8px; 
      margin-bottom: 10px; 
      border: 2px solid #eee;
      z-index: 1; 
    }

    /* Form Elements */
    label { display: block; text-align: left; font-weight: bold; margin-bottom: 8px; color: #333; font-size: 14px;}
    select { 
      width: 100%; padding: 12px; border-radius: 6px; 
      border: 1px solid #ccc; font-size: 16px; margin-bottom: 20px; background: #fff;
    }
    
    button { 
      background: #000; color: #fff; font-size: 16px; font-weight: bold;
      padding: 15px; width: 100%; border: none; border-radius: 6px; cursor: pointer; 
      transition: background 0.2s; margin-top: 10px;
    }
    button:hover { background: #333; }

    #status { margin-top: 20px; font-size: 14px; line-height: 1.5; }
    
    .coord-display { font-size: 13px; color: #555; margin-bottom: 15px; text-align: right; font-family: monospace;}
  </style>
</head>
<body>

<div class="card">
  <h2>üìÖ Event Sync</h2>
  <p class="subtext">Automatically sync local events from Luma to your Google Calendar</p>
  
  <label for="slug">1. Choose Category</label>
  <select id="slug">
    <option value="tech">Tech</option>
    <option value="ai" selected>AI</option>
    <option value="crypto">Crypto</option>
    <option value="arts">Arts & Culture</option>
    <option value="food">Food & Drink</option>
    <option value="fitness">Fitness</option>
    <option value="wellness">Wellness</option>
    <option value="climate">Climate</option>
  </select>

  <label>2. Select Area (Pan & Zoom Map)</label>
  <div style="text-align: right; margin-bottom: 10px;">
    <button onclick="goToMyLocation(this)" style="width: auto; padding: 10px 15px; margin: 0; font-size: 14px; white-space: nowrap;">üìç Locate Me</button>
  </div>
  <div id="map"></div>

  <button onclick="handleSync();">üîÑ Sync This Area</button>
  
  <div id="status"></div>
</div>

<script>
  // CONFIGURATION
  const CLIENT_ID = '465296465052-863gptjafq0b1o2ou4ovq8oggvmkgjmp.apps.googleusercontent.com'; // Paste from Step 1
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbzU6l1ZWG3J0AI_x8B0U5IiWTNWuaPY7DPaINYVHPLNR4VT2x-ikElaXDpG0bgytKyV1w/exec';     // @HEAD deployment (auto-updates)
  const REDIRECT_URI = 'https://diaorui.github.io'; // e.g. https://user.github.io

  // --- MAP SETUP ---
  var map = L.map('map').setView([37.7749, -122.4194], 10); // Default SF

  // Add Free Tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap',
    maxZoom: 18
  }).addTo(map);

  // 2. AUTO-LOCATE USER (Browser Geolocation)
  map.locate({
    setView: true,
    maxZoom: 12,
    timeout: 5000,
    enableHighAccuracy: false  // Faster on mobile
  });

  function onLocationFound(e) {
    // Optional: Add a marker showing "You are here"
    // L.marker(e.latlng).addTo(map).bindPopup("You are here").openPopup();
  }

  function onLocationError(e) {
    console.log("Could not auto-locate: " + e.message);
    // Silent fail: just stays on default view (SF)
  }

  map.on('locationfound', onLocationFound);
  map.on('locationerror', onLocationError);

  // Manual location button
  function goToMyLocation(btn) {
    var originalText = btn.innerHTML;

    // Show loading state
    btn.innerHTML = "‚è≥ Locating...";
    btn.disabled = true;

    // One-time listeners for this locate request
    function onFound(e) {
      btn.innerHTML = originalText;
      btn.disabled = false;
      map.off('locationfound', onFound);
      map.off('locationerror', onFail);
    }

    function onFail(e) {
      btn.innerHTML = originalText;
      btn.disabled = false;
      alert("Could not get your location. Please check permissions and try again.");
      map.off('locationfound', onFound);
      map.off('locationerror', onFail);
    }

    map.once('locationfound', onFound);
    map.once('locationerror', onFail);

    map.locate({
      setView: true,
      maxZoom: 12,
      timeout: 5000,           // 5 second timeout
      enableHighAccuracy: false, // Faster on mobile
      maximumAge: 10000        // Accept cached position up to 10s old
    });
  }


  // --- AUTH & SYNC ---
  var client;
  window.onload = function() {
    client = google.accounts.oauth2.initCodeClient({
      client_id: CLIENT_ID,
      scope: 'https://www.googleapis.com/auth/calendar.app.created openid email',
      ux_mode: 'popup',
      callback: (response) => {
        if (response.code) sendToBackend(response.code, null);
      }
    });
  };

  // Main sync handler - checks for cached token first
  function handleSync() {
    var cachedToken = localStorage.getItem('luma_access_token');
    var tokenExpiry = localStorage.getItem('luma_token_expiry');

    // Check if we have a valid cached token
    if (cachedToken && tokenExpiry && Date.now() < parseInt(tokenExpiry)) {
      // Use cached token
      sendToBackend(null, cachedToken);
    } else {
      // No valid token, trigger OAuth
      client.requestCode();
    }
  }

  function sendToBackend(authCode, accessToken) {
    var statusDiv = document.getElementById('status');
    statusDiv.innerHTML = "‚è≥ <b>Connecting...</b>";
    statusDiv.style.color = "blue";

    var bounds = map.getBounds();

    const config = {
      slug: document.getElementById('slug').value,
      north: bounds.getNorth(),
      south: bounds.getSouth(),
      east: bounds.getEast(),
      west: bounds.getWest()
    };

    var payload = { config: config };

    if (accessToken) {
      payload.access_token = accessToken;
    } else {
      payload.auth_code = authCode;
      payload.redirect_uri = REDIRECT_URI;
    }

    fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
      if(data.status === 'success') {
        // Cache the access token for 1 hour
        if (data.accessToken) {
          localStorage.setItem('luma_access_token', data.accessToken);
          localStorage.setItem('luma_token_expiry', Date.now() + 3600000); // 1 hour
        }

        var msg = "";
        if (data.action === 'created') {
          msg = `‚úÖ <b>Success!</b><br>Created calendar: <b>"${data.calendarName}"</b>`;
        } else {
          msg = `üîÑ <b>Updated!</b><br>Refreshed location for: <b>"${data.calendarName}"</b>`;
        }
        statusDiv.innerHTML = msg;
        statusDiv.style.color = "green";
      } else {
        // If token is invalid/expired, clear cache and retry with OAuth
        if (data.msg && data.msg.includes('token') && accessToken) {
          localStorage.removeItem('luma_access_token');
          localStorage.removeItem('luma_token_expiry');
          client.requestCode(); // Trigger fresh OAuth
        } else {
          statusDiv.innerHTML = "‚ùå Error: " + data.msg;
          statusDiv.style.color = "red";
        }
      }
    })
    .catch(err => {
      statusDiv.innerHTML = "‚ùå Network Error: " + err.message;
      statusDiv.style.color = "red";
    });
  }
</script>

</body>
</html>